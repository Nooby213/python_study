{% extends 'base.html' %}

{% block content %}
  <h1>Community</h1>
  <hr>
  {% for review in reviews %}
    <p>작성자 : <a href="{% url 'accounts:profile' review.user.username %}">{{ review.user }}</a></p>
    <p>글 번호: {{ review.pk }}</p>
    <p>글 제목: {{ review.title }}</p>
    <p>글 내용: {{ review.content }}</p>
    <form id = "likeForm_{{ review.pk }}" action="{% url 'community:like' review.pk %}" method="POST" data-review-id="{{ review.pk }}">
      {% csrf_token %}
      {% if request.user in review.like_users.all %}
        <input id = "likeBtn_{{review.pk}}" type="submit" value="좋아요 취소">
      {% else %}
        <input id = "likeBtn_{{review.pk}}" type="submit" value="좋아요">
      {% endif %}
    </form>
    <p>
      <span id = "like_Count_{{review.pk}}">{{review.like_users.all|length}}</span> 명이 이 글을 좋아합니다.
    </p>
    <a href="{% url 'community:detail' review.pk %}">[detail]</a>
    <hr>
  {% endfor %}
{% endblock content%}


{% block scripts %}
<script>
  const likeForms = document.querySelectorAll('[id^="likeForm_"]')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
  likeForms.forEach(likeForm => {
    likeForm.addEventListener('submit', function(event) {
      event.preventDefault() // 기본 이벤트를 중지합니다.
      
      // 해당 리뷰의 PK를 가져옵니다.
      const reviewPk = likeForm.getAttribute('data-review-id')
      
      axios({
        method: 'post',
        url: `/community/${reviewPk}/like/`,
        headers: { "X-CSRFToken": csrftoken },
      })
  .then((response) => {
    const isLiked = response.data.is_liked
    const likeBtn = document.querySelector(`#likeBtn_${reviewPk}`)

    if (isLiked === true) {
      likeBtn.value = '좋아요 취소'
    } else {
      likeBtn.value = '좋아요'
    }
    const likeCount = document.querySelector(`#like_Count_${reviewPk}`)// 좋아요 수를 표시하는 요소를 선택합니다.
    likeCount.textContent = response.data.like_count
  })
  .catch((error) => {
    console.log(error)
  })
})
  })
</script>
{% endblock scripts %}